#### Start of system configuration section. ####

srcdir = @srcdir@
VPATH = $(srcdir)

CC = @CC@
@SET_MAKE@

# INSTALL = @INSTALL@
# INSTALL_PROGRAM = @INSTALL_PROGRAM@
# INSTALL_DATA = @INSTALL_DATA@
# MAKEINFO = makeinfo
# TEXI2DVI = texi2dvi

export DEFS = @DEFS@
LIBS = @LIBS@

CFLAGS = -g -Wall -Wmissing-prototypes \
         -Wmissing-declarations -Werror # -O2 -fomit-frame-pointer
LDFLAGS = @LDFLAGS@

CPPFLAGS = -DDEBUG_ALLOC -DLSH -I$(srcdir) -I$(srcdir)/include

prefix = @prefix@
exec_prefix = $(prefix)

bindir = $(exec_prefix)/bin
infodir = $(prefix)/info

# Prefix to be prepended to each installed program, normally empty or `g'.
binprefix = 

#### End of system configuration section. ####

LOADLIBES = $(LIBS) lib/algorithms.a

COMMON_SRCS = alist.c atoms.c bignum.c channel.c \
	charset.c connection.c crypto.c \
	debug.c disconnect.c encrypt.c format.c getopt.c io.c keyexchange.c \
	packet_ignore.c pad.c parse.c publickey_crypto.c \
	randomness.c \
	read_data.c read_line.c read_packet.c service.c session.c \
	unpad.c \
	werror.c write_buffer.c xalloc.c

CLIENT_SRCS = lsh.c client.c client_keyexchange.c \
	client_password.c client_userauth.c
SERVER_SRCS = lshd.c server.c server_keyexchange.c\
	server_password.c server_userauth.c

SRCS = $(COMMON_SRCS) $(CLIENT_SRCS) $(SERVER_SRCS)

COMMON_OBJS = $(COMMON_SRCS:.c=.o)
CLIENT_OBJS = $(CLIENT_SRCS:.c=.o)
SERVER_OBJS = $(SERVER_SRCS:.c=.o)
OBJS = $(SRCS:.c=.o)

all: algorithms lsh lshd

.PHONY: all

.c.o:
	$(CC) -c $(CPPFLAGS) $(DEFS) $(CFLAGS) $<

lsh: $(CLIENT_OBJS) $(COMMON_OBJS)

lshd: $(SERVER_OBJS) $(COMMON_OBJS)

atoms_defines.h: atoms.in process_atoms
	bash process_atoms header <atoms.in >atoms_defines.h

atoms_gperf.c: atoms.in process_atoms Makefile
	bash process_atoms gperf <atoms.in \
             | gperf -t -c -l -k1,7,$$ -N gperf_atom >atoms_gperf.c

atoms_table.c: atoms.in process_atoms
	bash process_atoms table <atoms.in >atoms_table.c

algorithms:
	cd lib; \
        EXTRA_CPPFLAGS="-DLSH -I$(srcdir) -I$(srcdir)/include" \
	EXTRA_VPATH="$(srcdir):$(srcdir)/include" \
		$(MAKE) algorithms.a 

clean:
	rm -f *.o 

very_clean: clean
	rm *.d

%.d: %.c
	$(SHELL) -ec '$(CC) -MM -MG $(CPPFLAGS) $(DEFS) $< \
		| sed '\''s/\($*\)\.o:/\1\.o $@ : /g'\'' > $@'

include $(SRCS:.c=.d)

#### Remaking the Makefile and configure scripts. ####

#${srcdir}/configure: configure.in aclocal.m4
${srcdir}/configure: configure.in
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file.
${srcdir}/config.h.in: stamp-h.in

#${srcdir}/stamp-h.in: configure.in aclocal.m4 acconfig.h \
#    config.h.top config.h.bot

${srcdir}/stamp-h.in: configure.in 
	cd ${srcdir} && autoheader
	echo timestamp > ${srcdir}/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status

Makefile: Makefile.in config.status
	./config.status

config.status: configure
	./config.status --recheck
