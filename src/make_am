#! /bin/bash

# This program wants to recieve a list of needed headers on stdin. It
# reads Makefile.am.in and creates Makefile.am.

if [ x$1 != x ]; then
    dir=$1
    top=n0
else
    dir=.
    top=yes
fi

echo 1>&2 "make_am: dir='$dir'"

# Input file on fd 3
if [ -f $dir/Makefile.am.in ]; then
    exec 3<$dir/Makefile.am.in
else
#    echo 1>&2 "make_am: No Makefile.am.in in $dir"
    exit 0
fi

# Output file on fd 4
exec 4>$dir/Makefile.am
echo 1>&4 '##' "Automatically generated by make_am, `date`"
echo 1>&4 '##' "Process this file with automake to produce Makefile.in"
echo 1>&4

function get_header() {
    keyword=''
    while [ x$keyword = x ]; do
	read <&3 keyword args
	if [ $? != 0 ]; then
	    echo 1>&2 "make_am: Unexpected end of file"
	    exit 1
	fi
	case $keyword in
            \#*)
                keyword=''
                ;;
	    *:)
		keyword=`echo $keyword | sed 's/^\(.*\):$/\1/'`
		;;
        esac ;
    done
    echo "get_header: '$keyword'"
}

# Run commands with the same data on stdin
commands=""

function add_command {
    commands="$commands tee >($1 ; cat >/dev/null) |"
}

function run_commands {
    echo 1>&2 "run_commands: $commands cat >/dev/null"
    /bin/bash -c "$commands cat >/dev/null"
}

subdirs=''

while true; do
    get_header;
    case $keyword in
	CVS_HEADERS)
	    add_command "(echo $args=\\\\;
	    comm -12 - <(./cvs_headers $dir) | sed 's/\$/ \\\\/';
	    echo) 1>&4"
	    ;;
	SUBDIRS)
	    subdirs=$args
	    echo 1>&4 "SUBDIRS = $args"
	    for d in $args; do
		add_command "$0 $dir/$d"
	    done
	    ;;
	BODY)
	    if [ $top = yes ]; then
		exec <(./used_headers . $subdirs)
	    fi
	    run_commands && cat <&3 >&4
	    exit 0
	    ;;
	*)
	    echo 1>&2 "make_am: Unknown keyword '$keyword'"
	    exit 1
	    ;;
    esac
done
