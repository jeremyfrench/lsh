2002-11-18  Niels Möller  <niels@s3.kth.se>

	* certificate.c (spki_cert_parse_body): Deleted function (replaced
	by code in parse.c).
	(spki_5_tuple_free_chain): New function.
	(spki_process_sequence_no_signatures): New function.

	* parse.c (spki_parse_cert): New function.

	* spki-types.in: Added do, sequence and signature.

	* Makefile.am (spki-gperf.h, spki-type-names.h, spki-types.h):
	Changed $(srcdir) handling again.

	* parse.c (spki_parse_acl_entry): New function.

	* certificate.c (parse_acl_entry): Deleted function (moved to
	parse.c).
	(spki_acl_parse): Rewrote to use spki_parse_acl_entry.

	* certificate.h (SPKI_MALLOC, SPKI_FREE, SPKI_NEW): New macros,
	moved from certificate.c.

2002-11-18  Niels Möller  <nisse@cuckoo.hack.org>

	* testsuite/Makefile.am (TS_PROGS): Added date-test.

	* testsuite/testutils.h: Include string.h.

	* testsuite/read-cert-test.c (test_main): Check the validity
	information. 

	* testsuite/date-test.c: New file, testing spki_date functions.

	* spki-types.in: Added not-before and not-after.

	* certificate.h (struct spki_struct): New struct, containing a
	date string. 
	(struct spki_5_tuple): Use struct spki_date instead of time_t.

	* certificate.c (parse_valid): Deleted placeholder functiom.
	(parse_version): Deleted function, moved to parse.c.
	(parse_acl_entry): Use spki_parse_valid and spki_parse_version.
	(spki_cert_parse_body): Likewise.

	* parse.c (spki_parse_date): New function.
	(spki_parse_valid): New function.
	(spki_parse_version): New function.

	* certificate.c (spki_date_from_time_t): New function.
	(spki_date_cmp_time_t): New function.

2002-11-17  Niels Möller  <nisse@cuckoo.hack.org>

	* configure.ac: Removed RCS id line.

	* certificate.c (spki_dup): Made function non-static.
	(parse_tag_body): Deleted function.
	(parse_acl_entry): Follow new parser function conventions. Use
	spki_parse_tag, spki_parse_skip and spki_parse_end.
	(spki_acl_parse): Adapt to new conventions.
	(parse_skip_optional): Deleted function.
	(spki_cert_parse_body): Use spki_parse_tag.

	* parse.c (spki_parse_skip): New function, replacing
	certificate.c:parse_skip_optional. 
	(spki_parse_tag): New function, replacing
	certificate.c:parse_tag_body. 

	* Makefile.am (libspki_a_SOURCES): Added parse.c.

	* configure.ac: Check for gcc's __attribute__, and use AH_BOTTOM
	to define UNUSED, NORETURN and PRINTF_STYLE.

	* process-types: Renamed SPKI_TYPE_UNKNOWN to
	SPKI_TYPE_SYNTAX_ERROR. 

	* parse.h: New file.

	* parse.c: New file.
	(spki_intern): Moved function here, from certificate.c.
	(spki_parse_type): Likewise, and renamed from spki_get_type.
	(spki_parse_end): New function.
	(spki_parse_principal): New function, replacing...
	* certificate.c (parse_principal): ... deleted function.
	(parse_tag): Deleted function.
	(parse_tag, parse_acl_entry): Rewrite to use spki_parse_principal.
	(spki_cert_parse_body): Likewise.
	
2002-11-16  Niels Möller  <nisse@cuckoo.hack.org>

	* testsuite/principal-test.c: Use testutils.h
	* testsuite/read-acl-test.c: Likewise.

	* testsuite/Makefile.am (TS_PROGS): Added read-cert-test.
	(LDADD): Added testutils.o.

	* testsuite/testutils.c, testsuite/testutils.h: New files.

	* testsuite/read-cert-test.c: New test case.

	* certificate.c (spki_get_type): Return SPKI_TYPE_END_OF_EXPR at
	end of expression.
	(parse_tag, parse_tag_body): Split parse_tag into two functions.
	(parse_valid): Placeholder for real function.
	(parse_version): New function.
	(parse_skip_optional): New function.
	(spki_cert_parse_body): New function.
	(spki_cert_parse): New function.

	* process-types: New pseudo-type SPKI_TYPE_END_OF_EXPR.

	* spki-types.in: Added cert, dispaly, issuer, issuer-info,
	subject-info. 

	* testsuite/Makefile.am (check): Set LD_LIBRARY_PATH when running
	tests. 

	* configure.ac: Check for GMP, and fail if it's not present.

2002-11-15  Niels Möller  <niels@s3.kth.se>

	* testsuite/Makefile.am (AM_LDFLAGS): Need -L../../nettle.
	(TS_PROGS): Added read-acl-test.

	* testsuite/read-acl-test.c: New test case.

	* testsuite/principal-test.c: Renamed file, was subject-test.c. 

	* certificate.c (hash_data): New function.
	(spki_principal_add_key): Made static. Use hash_data, and set the
	flags.
	(spki_principal_add_md5): New function.
	(spki_principal_add_sha1): New function.
	(spki_principal_by_key): Compare hashes. Create new principal if
	no old one matches.
	(spki_principal_by_md5): Check flag to see if md5 hash of each
	principal on the list is known.
	(spki_principal_by_sha1): Likewise, for sha1.
	(spki_check_type): Advance iterator past the matched type.
	(parse_principal): Handle hashes.
	(parse_tag): New function.
	(parse_acl_entry): Unlike certificates, subexpressions must come
	in order, and there's no <subject>-expression.
	(spki_acl_parse): Fixed version check.

	* certificate.h (struct spki_hashes): New struct.
	(enum spki_principal_flags): New enum.
	(struct spki_principal): Use flags to keep track of which hash
	values are known.
	(enum spki_5_tuple_flags): Renamed, was spki_flags.

	* spki-types.in: Added "comment" and "valid".

2002-11-14  Niels Möller  <niels@s3.kth.se>

	* spki-types.in: Added types public-key, md5 and sha1.

	* certificate.c (spki_principal_add_key): Deleted code for
	dynamic allocation of hash digests.
	(spki_principal_by_md5): New function.
	(spki_principal_by_sha1): New function.
	(parse_principal): Implemented handling of public key and hash
	expressions.

	* certificate.h (struct spki_principal): Store hashes directly in
	the struct, without pointers.

	* Makefile.am (bootstrap): New target.
	(spki-types.h, spki-type-names.h, spki-gperf.h): Create files in
	the source tree. 

2002-11-14  Niels Möller  <nisse@cuckoo.hack.org>

	* certificate.h (struct spki_5_tuple): Renamed (was spki_acl), and
	added issuer field.

2002-11-13  Niels Möller  <nisse@cuckoo.hack.org>

	* certificate.c: Include automatically generated files.
	(spki_intern): New function.
	(spki_get_type): New function.
	(spki_check_type): New function.
	(parse_principal): Placeholder for needed function.
	(parse_acl_entry): New function.
	(spki_acl_parse): Use parse_acl_entry.

	* Makefile.am: Added rules for process-types and related files.

	* spki-types.in: New file, containing listing spki's magic words.

	* process-types: New file, similar to lsh's process_atoms.

2002-11-13  Niels Möller  <niels@s3.kth.se>

	* certificate.c (spki_acl_parse): New function (not done yet).

	* certificate.h, certificate.c: Fixed terminology, refer to keys
	as "principals", not "subjects". 

	* Makefile.am (AM_CPPFLAGS): Use $(srcdir).
	* testsuite/Makefile.am (AM_CFLAGS): Use $(top_srcdir).

	* .bootstrap: Run autoheader before autoconf.

2002-11-13  Niels Möller  <nisse@cuckoo.hack.org>

	* testsuite/subject-test.c: First test case.

	* testsuite/run-tests: Copied from lsh:s testsuite.

	* certificate.c: Implemented basic handling of keys.

