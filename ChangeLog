2000-05-28  Niels Möller  <nisse@cuckoo.localdomain>

	* src/unix_user.c (do_read_file): Changed USER_READ_FILE to use
	exceptions and continuations.

	* src/ssh.h: Added message numbers for SRP key exchange and dh
	group negotiation. 

	* src/srp_exchange.c: Various bugfixes. At least compiles now.

	* src/sexp.c (sexp_check_type_l): Renamed tthe sexp_check_type
	function. 
	(sexp_check_type): Moved and renamed the spki_check_type function.
	(sexp2bignum_u): New function.
	(sexp_atom_eq): New function.
	(sexp_atoms_eq): Renamed the previos sexp_atom_eq function.
	(sexp_get_un): Use sexp2bignum_u.

	* src/publickey_crypto.h: Renamed all occurences of
	"diffie_hellman" do "dh".

	* src/publickey_crypto.c (zn_ring_add): New function.
	(zn_ring_subtract): New function.

	* src/keyexchange.c (kex_build_secret): Use a string rather than a
	bignum for the third argument.
	(keyexchange_finish): New function.

	* src/io.c (check_user_permissions): Made fname argument const.
	(io_read_user_file): Fixed call to fstat().

	* src/invert-defs: Use -u flag to sort (is that a GNU:ism?)

	* src/exception.c (make_protocol_exception): Updated with new
	messages. 

	* src/dh_exchange.c (dh_hash_update): New (or ersurrected)
	function. 
	(dh_hash_digest): Don't hash the host key here.
	(dh_make_server_msg): Hash host key.
	(dh_process_server_msg): Likewise.

	* src/client_keyexchange.h (make_srp_client): New prototype.

	* acconfig.h: Added WITH_SRP.

	* configure.in: Include sys/types.h when checking for utmp
	members.
	Added --disable-srp option.

	* src/client_keyexchange.c (do_handle_dh_reply): Use
	keyexchange_finish().
	First attempt at SRP support.
	* src/server_keyexchange.c: Likewise
	
	* src/atoms.in: Added srp-group1-sha1, srp-verifier and ssh-group1.

2000-05-27  Niels Möller  <nisse@cuckoo.localdomain>

	* src/testsuite/Makefile.am (TS_MORE_SH): Added lsh-4-test.

	* src/publickey_crypto.h: Renamed the class group to abstract_group.
	(GROUP_RANGE): Renamed from GROUP_MEMBER, as it actually doesn't
	check membership.
	(GROUP_SMALL_POWER): New method, for raising a group element to a
	power that fits in an UINT32.
	(abstract_group): Added generator attribute.

	* src/publickey_crypto.c: Moved most dh-related code to
	dh_exchange.c. Moved the definition of the group_zn class to
	publickey_crypto.h. 

	* src/Makefile.am.in (liblsh_a_SOURCES): Added dh_Exchange.c and
	srp_exchange.c. 

	* src/userauth.h (lsh_user): Added read_file method.

	* src/unix_user.c (do_read_file): New function.
	(make_unix_user_db): Added backend argument.

	* src/io.c (check_user_permissions): New function.
	(io_read_user_file): New function.

	* src/io.h (io_read_user_file): Added prototype.

2000-05-24  Niels Möller  <nisse@cuckoo.localdomain>

	* contrib/lsh.spec.in: Use -o flag for lsh_writekey (Thayne).

2000-05-22  Niels Möller  <nisse@cuckoo.localdomain>

	* src/io.c (do_kill_fd): Call close_fd_nicely(). This fixes a
	problem, where output from for instance "lsh host echo foo" loses
	output because the channel is closed before the output is flushed
	from the write buffer.

	* src/channel.c (adjust_rec_window): Check the state of the
	channel, and send the SSH_MSG_CHANNEL_WINDOW_ADJUST message only
	if it makes sense.

	* src/dsa.c (do_dsa_verify): Removed the extra length field, as it
	seems it will disappear in the next draft.
	(do_dsa_sign): Likewise.

2000-05-21  Niels Möller  <nisse@cuckoo.localdomain>

	* configure.in: Bumped version to 0.9.10.

	* acinclude.m4 (AC_SEARCH_LIBGMP): Use HAVE_GMP_H and
	HAVE_GMP2_GMP_H. 

	* configure.in (gmp_header_found): Changed "no gmp" error message
	not to refer to a particular version.

	* src/dsa.c (do_dsa_verify): Require outer length field.
	(do_dsa_sign): Add outer length field.

	* src/ssh.h (SSH_DISCONNECT_TOO_MANY_CONNECTIONS): Updated for
	draft-ietf-secsh-transport-07.txt.
	(SSH_DISCONNECT_AUTH_CANCELLED_BY_USER): Likewise.
	(SSH_DISCONNECT_NO_MORE_AUTH_METHODS_AVAILABLE): Likewise.
	(SSH_DISCONNECT_ILLEGAL_USER_NAME): Likewise.
	(SSH_DISCONNECT_RESERVED): Likewise.

	* src/client.c (do_exit_signal): Use control character filtering
	on the message.

2000-05-19  Niels Möller  <nisse@lysator.liu.se>

	* src/client_userauth.c (do_userauth_pk_ok): Moved else across
	"#endif /* DATAFELLOWS_WORKAROUNDS */" (reported by Sami
	Lehtinen). 

2000-05-09  Niels Möller  <nisse@lysator.liu.se>

	* src/unix_user.c (do_fork_process): Check HAVE_UT_NAME and
	HAVE_UT_USER. 

2000-05-08  Niels Möller  <nisse@cuckoo.localdomain>

	* acconfig.h (HAVE_UT_NAME): Added.
	(HAVE_UT_USER) Added.

	* configure.in: Bumped version to 0.9.9.
	Added --with-lib-path option, RPATH handling, and checks for
	libutil.h, ut_name and ut_user. Fixed gmp check to recognize
	gmp-3.x. 

	* src/unix_user.c: Include libutil.h if available (reported by
	Jonathan McDowell).
	(lsh_make_utmp): Use ut_user if ut_name is not available.
	(reported by Jonathan McDowell).

	* src/server_session.c: Include signal.h (reported by Jonathan
	McDowell). 

	* src/symmetric/desTest.c: Eliminate warnings.

	* src/io.c (address_info2sockaddr) [!HAVE_GETADDRINFO]: Initialize
	addr->sin_family properly (reported by Jonathan McDowell).

	* acinclude.m4 (LSH_RPATH_INIT): New macro.
	(LSH_RPATH_FIX): Likewise.
	(AC_SEARCH_LIBGMP): Likewise.

2000-05-07  Niels Möller  <nisse@cuckoo.localdomain>

	* src/lsh_types.h: Include stddef.h.

	* configure.in: Fixes for recognizing gmp-3.x.

	* acinclude.m4 (AC_CHECK_LIBGMP): New macro.

	* acconfig.h: Added HAVE_LIBGMP

2000-05-06  Niels Möller  <nisse@cuckoo.localdomain>

	* configure.in: Bumped version to 0.9.8.

	* src/sexp.c (sexp_argp_parser): Renamed output-format option from
	-o to -f.

	* src/lsh_writekey.c (main_options): #if:ed out the -f alias.

	* doc/lsh.texinfo (Getting started): Updated example on using
	lsh_writekey. 

	* src/tcpforward_commands.c (do_remote_port_install_continuation):
	Handle only the successful case here.

	* src/connection.c (make_ssh_connection): Bugfix: Don't apply
	SSH_CHANNEL_MAX_PACKET_FUZZ here.

	* src/client_userauth.c (client_publickey_next): Fixes for the
	case where we send complete signatures for several keys.

2000-05-01  Niels Möller  <nisse@cuckoo.localdomain>

	* src/testsuite/keygen-test: Use -o flag to lsh_writekey.

	* src/spki_commands.c (make_pkcs5_encrypt): New function.

	* src/spki.c: Deleted old #if'ed out code.

	* src/sexp.c (sexp_s): Renamed from make_sexp_string(). Updated
	all callers.

	* src/pkcs5.c (pkcs5_derive_key): Renamed pkcs5_key_derivation().
	Added comments trying to analyze the choice of iteration count.

	* src/lsh_writekey.c: Major reorganization. Use argp, and support
	pkcs5-style encryption. 

	* src/lsh_keygen.c (main_argp_parser): Removed ARGP_KEY_ARG case. 
	* src/lshd.c (main_argp_parser): Likewise.

	* src/io.c (safe_pushd): Use char * for the directory argument. 

	* src/crypto.h (pkcs5_derive_key): Renamed pkcs5_key_derivation(). 

	* src/algorithms.c (lookup_crypto): Added an extra argument for
	returning tha algorithm object, not just the name. Updated all
	callers. 
	(lookup_mac): Likewise.
	(lookup_compression): Likewise.
	(lookup_hash): Likewise.
	(vlist_algorithms): Made non-static. 
	(list_algorithms): Likewise.
	(list_crypto_algorithms): Likewise.
	(list_mac_algorithms): Likewise.
	(list_compression_algorithms): Likewise.

	* src/abstract_crypto.c (crypt_string_pad): New function.
	(crypt_string_unpad): New function.

	* src/Makefile.am.in (noinst_PROGRAMS): Added pkcs5-test.

2000-04-23  Niels Möller  <nisse@cuckoo.localdomain>

	* src/testsuite/Makefile.am (TS_PROGS): Added twofish-test.

	* Constness improvements.
	
	* src/pkcs5.c: New file.

	* src/keyexchange.c (kex_make_mac): Pass key length to MAKE_MAC. 

	* src/io.c (safe_popd): New function.
	(safe_pushd): New function.

	* src/hmac.c (make_hmac_instance): Added key length argument, and
	implemented variable size keys.

	* src/gc.c (gc_kill): Implemented early deallocation.

	* src/crypto.h (pkcs5_key_derivation): Added prototype.

	* src/abstract_crypto.h (MAKE_MAC): Added key length argument. 
	Const-ness fixes.

	* src/Makefile.am.in (liblsh_a_SOURCES): Added pkcs5.c. 

	* acinclude.m4 (AC_CHECK_MEMBER): Bug fix. 

2000-04-22  Niels Möller  <nisse@lysator.liu.se>

	* src/unix_user.c (lsh_make_utmp): Check HAVE_UT_HOST.

	* src/io.c: include sys/stat.h
	(io_listen_local, io_connect_local): Use AF_UNIX, not AF_LOCAL

2000-04-22  Niels Möller  <nisse@cuckoo.localdomain>

	* configure.in: Bumped version.

2000-04-21  Niels Möller  <nisse@cuckoo.localdomain>

	* Removed lots of old #if:ed out code.
	
	* src/testsuite/lsh-cat-test: Use diff to check result.

	* src/userauth.h: Added more arguments to the USER_FORK method. 

	* src/unix_user.c (make_logout_cleanup): New function.
	(lsh_strncpy): New funtion.
	(lsh_strncpy_tty): Kew function.
	(lsh_make_utmp): New function.
	(process_resource): Class moved here from server_session.c. 
	(do_fork_process): Added utmp/wtmp support, and some more
	arguments. 

	* src/tcpforward_commands.c (do_tcpip_connect_io): Take a
	listen_value as argument, not an lsh_fd.

	* src/sexp_commands.c (do_read_sexp): Changed
	CAST_SUBTYPE(lsh_fd...) to CAST(lsh_fd...)
	* src/tcpforward.c (do_tcpip_forward_request_continuation):
	Likewise. 

	* src/server_session.c (spawn_process): Added peer argument, and
	updated callers.
	(spawn_process): Adapted to the changed USER_FORK method.

	* src/lsh.h: Added forward declarations for struct reap and struct
	exit_callback. 

	* src/io_commands.c (make_connect_continuation): New function. 
	(do_connect): Return a listen_value, not an lsh_fd. Now,
	"listen_value" is an inappropriate name.

	* src/io_commands.c (io_log_peer_command): Don't strip peer
	information.  

	* src/io.c (io_listen_local): Use fchdir().
	(io_connect_local): New function.

	* src/connection_commands.c (do_handshake): Take a listen_value
	as argument, not an lsh_fd.

	* src/connection.c (make_ssh_connection): Added peer argument. 

2000-04-20  Niels Möller  <nisse@cuckoo.localdomain>

	* src/tcpforward_commands.c: Changed uses of listen_command to
	listen_callback.

	* src/tcpforward.c (do_tcpip_forward_request_continuation,
	do_tcpip_forward_request_exc): Moved handling of the failure case
	to the exception handler.

	* src/io_commands.c (make_simple_listen): Deleted resources argument.
	(make_remember_continuation): New function. (Currently not used).
	(do_listen): Generalized, so that it can be used by all of
	do_simple_listen, do_listen_with_callback and do_listen_with_connection.
	(listen_with_callback):  Renamed the improperly named listen_connection.
	(listen_with_connection): New command.

	* src/client_userauth.c (make_banner_handler): Replaced with
	a static object.

	* src/channel.c (do_channel_open): Use SSH_CHANNEL_MAX_PACKET_FUZZ
	* src/server_session.c (make_server_session): Likewise.
	* src/client.c (make_client_session): Likewise.
	* src/tcpforward.c (make_tcpip_channel): Likewise

	* src/command.h (command_context): Updated comment.

	* src/connection.c (make_fail_handler): Replaced with static object.
	(make_unimplemented_handler): Likewise.

	* src/disconnect.c (make_disconnect_handler): Replaced with a
	static object.

	* src/io.c (choose_address): Choose one address fron an
	addrinfo-list, using a list of preferred address families.
	(address_info2sockaddr): Added preference argument. Updated all
	calls. 

	* src/lookup_verifier.h (lookup_verifier): Updated comments. 

	* src/zlib.c (struct zlib_type): New type.
	(do_free_zstream): Don't rely on casting the void * opaque to a
	function pointer. 
	(do_zlib): Improved messages.

	* src/read_data.c (make_read_data): Deleted the overhead argument. 

	* src/ssh.h (SSH_CHANNEL_MAX_PACKET_FUZZ): New constant.

	* src/algorithms.c (prefer_compression_algorithms): New function. 
	(algorithms_argp_parser): Changed behaviour of -z with no argument.

	* doc/lsh.texinfo (Algorithm options): Documented change of -z
	behaviour. 

2000-04-19  Niels Möller  <nisse@cuckoo.localdomain>

	* src/xalloc.h [DEBUG_ALLOC] (CHECK_TYPE, CHECK_SUBTYPE): Return
	the object pointer. Needed by CLONE()

	* src/userauth.h (lsh_user): Added tty-argument to the fork
	method. 

	* src/unix_user.c (do_fork_process): Call logwtmp. For now, the
	host-name is bogus.

	* src/server_session.c (do_kill_process): Call logout(), to update
	wtmp. 
	(spawn_process): Construct tty name for utmp/wtmp logging.
	(lsh_basename): New function.

	* src/lsh.c, src/lshd.c, src/lsh_proxy.c: Improved default
	behaviour if no --port argument is given.

	* src/io_commands.c (do_listen, do_listen_connection, do_connect):
	IPv6 support. 

	* src/io.c (get_inaddr): Removed.
	(tcp_addr): Likewise.
	(make_address_info_c): Added an extra argument used as fallback if
	service lookup fails.
	(sockaddr2info): IPv6 support.
	(address_info2sockaddr): Rewrote, to handle IPv6 and to allocate
	the returned sockaddr structure dynamically.

	* src/connection.h (ssh_connection): Added peer attribute,
	currently unused.

	* src/atoms.in: Added rsa-related atoms.

	* configure.in: Replaced many calls to AC_ARG_WITH with
	AC_ARG_ENABLE. Added --disable-ipv6 and --disable-utmp flags.

	* acconfig.h: Added WITH_IPV6 and WITH_UTMP.

2000-04-18  Niels Möller  <nisse@cuckoo.localdomain>

	* src/io_commands.c (do_listen_continue): Use make_listen_value().

2000-04-17  Niels Möller  <nisse@cuckoo.localdomain>

	* src/publickey_crypto.h (make_rsa_algorithm): Added prototype. 

	* src/io.c (io_iter): Use #ifdef:s around tests for POLLNVAL,
	POLLPRI and POLLHUP.

	* configure.in: Bumped version to 0.9.6.

2000-04-16  Niels Möller  <nisse@cuckoo.localdomain>

	* src/io.c (io_listen): Take a sockaddr * rather than a
	sockaddr_in *. 
	(io_listen_local): Implemented local sockets. Currently #if:ed
	out. 

	* src/io_commands.c (do_listen): Pass a sockaddr * rather than a
	sockaddr_in * to io_listen.
	(do_listen_connection): Likewise.

	* src/lsh_types.h (OFFSETOF): Define, if needed.

	* src/lsh.h (NUL_TERMINATED): New macro.

	* src/dsa.c (WITH_DSA_CLASSIC): Deleted this unused macro.

	* configure.in (lsh_cv_c_offsetof): Check for offsetof.

	* src/unix_user.c (make_unix_user): Use NUL_TERMINATED macro.

	* acconfig.h (HAVE_C_OFFSETOF): New macro. 

2000-04-13  Niels Möller  <nisse@lysator.liu.se>

	* src/unix_user.c (do_exec_shell): Fixed debug() call.

2000-04-12  Niels Möller  <nisse@cuckoo.localdomain>

	* src/testsuite/Makefile.am (TS_MORE_SH): Added lsh-cat-test.

	* src/testsuite/functions.sh (exec_lsh): New function. 

	* src/server_session.c (do_spawn_exec): Don't spawn a login-mode
	shell.
	(do_send_adjust): Check that files are alive before operating on
	them. 

2000-04-11  Niels Möller  <nisse@cuckoo.localdomain>

	* src/io.c (io_listen_local): Started on AF_LOCAL support.
	Currently disabled.

2000-04-11  Niels Möller  <nisse@lysator.liu.se>

	* src/lshd.c (main_argp_parser): Fixed root-login option.

2000-04-10  Niels Möller  <nisse@cuckoo.localdomain>

	* configure.in: Bumped version to 0.9.5.
	Fixed descriptions of options.

2000-04-06  Niels Möller  <nisse@lysator.liu.se>

	* src/channel.c (do_window_adjust): Allow CHANNEL_WINDOW_ADJUST
	when we have received EOF but not CLOSE. Noted by Markus Friedl.

2000-04-02  Niels Möller  <nisse@lysator.liu.se>

	* configure.in: Bumped version to 0.9.4.

	* src/userauth.h: Renamed class user to lsh_user, to avoid name
	clash with glibc. 

2000-04-02  Niels Möller  <nisse@cuckoo.localdomain>

	* contrib/Makefile.am (EXTRA_DIST): Added lshd.debian.init 

2000-04-01  Niels Möller  <nisse@cuckoo.localdomain>

	* src/unix_user.c (do_exec_shell): Fixed MAX_ENV check.

2000-03-29  Niels Möller  <nisse@cuckoo.localdomain>

	* src/unix_user.c (do_lookup_user): Improved shadow support,
	following suggestions by Thayne Harbaugh.

2000-03-28  Niels Möller  <nisse@cuckoo.localdomain>

	* contrib/lshd.rhlinux.init: chkconfig priorities.

2000-03-26  Niels Möller  <nisse@cuckoo.localdomain>

	* src/server_session.c (server_session): New attribute
	initial_window. 

	* src/client.c (make_client_session): Removed references to
	max_window. 

	* src/channel.c (channel_start_receive): Added argument
	initial_window_size. Removed references to max_window.
	(format_global_request): New function.

	* src/channel.h (ssh_channel): Removed obsolete max_window
	attribute.  
	(channel_open): Added send_window_size argument.

	* src/Makefile.am.in (liblsh_a_SOURCES): Added gateway_channel.c.
	Removed proxy_channel.c.

	* src/gateway_channel.c: New file. More or less copied from
	proxy_channel.c. 

2000-03-19  Niels Möller  <nisse@cuckoo.localdomain>

	* src/unix_user.c (do_lookup_user): Honor shadow-style password
	aging and account expiration.

	* configure.in: Bumped version to 0.9.2.

	* src/unix_user.c (do_file_exists): Deallocate the name properly.

	* src/server_authorization.c (do_key_lookup): Don't free the
	filename twice.

2000-03-16  Niels Möller  <nisse@cuckoo.localdomain>

	* src/proxy.c, src/proxy.h: Merged changes (Bazsi).

	* src/lsh_proxy.c: More features (Bazsi).

	* src/lsh.c (WINDOW_SIZE): Decreased to 10000.
	* src/server_session.c (WINDOW_SIZE): Likewise.

	* src/channel.h (ssh_channel): Replaced CHANNEL_SEND method with
	CHANNEL_SEND_ADJUST. 
	(CHANNEL_OPEN): Added send_max_packet argument.

	* src/channel.c (format_open_confirmation): Added debug output. 
	(do_channel_open): Pass send_packet_size to the CHANNEL_OPEN
	method, and round it down to SSH_MAX_PACKET if needed.
	(do_window_adjust): Pass the window adjustment to the
	CHANNEL_SEND_ADJUST method.

	(do_channel_data): Check that data length is less than
	rec_max_packet. More debug output.
	(do_channel_extended_data): Likewise.

	* src/proxy_agentforward.c, src/proxy_agentforward.h,
	proxy_x11forward.c, proxy_x11forward.h: New files (Bazsi). 

	* src/Makefile.am.in (liblsh_a_SOURCES): Added
	proxy_agentforward.c and proxy_x11forward.c.

	* configure.in: Bumped version to 0.9.1.
	(--without-x11-forward, --without-agent-forward): New flags. So
	far, used only by the proxy.

	* acconfig.h (WITH_X11_FORWARD, WITH_AGENT_FORWARD): New defines.  

2000-03-14  Niels Möller  <nisse@cuckoo.localdomain>

	* src/server_session.c (do_spawn_exec): New function.
	(make_exec_handler): New function.

	* src/lshd.c (main): Enable command execution.

	* src/format.c (make_cstring_l): New function.

2000-03-13  Niels Möller  <nisse@lysator.liu.se>

	* src/lsh.c (lsh_options): Renamed stdin attribute to stdin_file,
	and similarly for stdout and stderr.

2000-03-08  Niels Möller  <nisse@cuckoo.localdomain>

	* src/server_session.c (do_login): Fixed message.
	(do_spawn_shell): Adapted to improved user class.

	* src/server_userauth.h: Removed unix_user_db class (moved to
	unix_user.c). 

	* src/server_publickey.c (do_authenticate): Use the user
	superclass rather than unix_user.

	* src/server_password.c (do_authenticate): Use the new
	USER_VERIFY_PASSWORD method.

	* src/server_authorization.c (do_key_lookup): Use the new
	USER_FILE_EXISTS method.

	* src/Makefile.am.in (liblsh_a_SOURCES): Added unix_user.c.

	* src/werror.c (error_fd): Made  static.
	(dup_error_stream): New function.
	(set_error_ignore, set_error_syslog): Set error_fd to -1.

	* src/userauth.h (user): Added uid attribute, and a bunch of
	methods. 

	* src/unix_user.c: New file, implementing the unix_user class. 

2000-03-07  Niels Möller  <nisse@cuckoo.localdomain>

	* src/lsh.c: Implemented rsh-style operation, and the -S and -E
	action options. 

	* src/client.c (make_exec_request): New function.

2000-03-06  Niels Möller  <nisse@cuckoo.localdomain>

	* src/client_pty.c (do_format_pty_request): Free the terminal-mode
	string. 

2000-03-02  Niels Möller  <nisse@cuckoo.localdomain>

	* src/rsync/send.c: Improved the sending state machine. Still
	missing some pieces.

	* src/rsync/checksum.c (rsync_search): Increment i in the middle
	of the loop.

	* src/rsync/Makefile.am (librsync_a_SOURCES): Added send.c.

2000-02-27  Niels Möller  <nisse@cuckoo.localdomain>

	* src/rsync/generate.c (rsync_update): Call rsync_update_1.

	* src/rsync/Makefile.am (librsync_a_SOURCES): Added checksum.c. 

2000-02-26  Niels Möller  <nisse@cuckoo.localdomain>

	* src/Makefile.am.in (SUBDIRS): Added rsync.

	* configure.in (lsh_cv_c_attribute): Output src/rsync/Makefile. 

	* src/lsh_types.h (WRITE_UINT16): Added READ_UINT16 and
	WRITE_UINT16 macros.

	* src/connection_commands.c (do_line): Recognize ssh-2.1.0 (Markus
	Friedl) 

2000-02-22  Niels Möller  <nisse@cuckoo.localdomain>

	* doc/lsh.texinfo (Invoking lshd): Adding doc for --root-login. 

	* src/version.h (BUG_ADDRESS): New constant.

	* src/userauth.h (user): New class.

	* src/sexp_conv.c (argp_program_version,
	argp_program_bug_address): New constants.

	* src/server_userauth.c (make_unix_user_db): New function.
	(do_lookup_user): Check allow_root flag.

	* src/server_session.c (do_login): Write log message.

	* src/server_publickey.c (make_userauth_publickey): Take user_db
	argument.
	
	* src/server_password.c (make_userauth_password): New function. 

	* src/server_authorization.c (do_key_lookup): Take user as
	argument. 

	* src/lshd.c (argp_program_version, argp_program_bug_address): New
	constants.
	(main_options): New options --root-login and --no-root-login.
	(main_argp_parser): Use make_unix_user_db().

	* src/lsh_proxy.c (argp_program_version,
	argp_program_bug_address): New constants.

	* src/lsh_keygen.c (argp_program_version,
	argp_program_bug_address): New constants.

	* src/lsh.c (argp_program_version): New constant. 
	(argp_program_bug_address): New constant.

	* src/lookup_verifier.h (lookup_verifier): Changed third argument
	to authenticate method to struct user. 

	* src/lsh.h: Added forward declaration of struct user.

2000-02-21  Niels Möller  <nisse@cuckoo.localdomain>

	* src/algorithms.c (vlist_algorithms): New function.
	(list_algorithms): New function.
	(list_crypto_algorithms): New function.
	(list_mac_algorithms): New function.
	(list_compression_algorithms): New function.
	(algorithms_options): New option --list-algorithms.
	(algorithms_argp_parser): List supported algorithms on errors. 

2000-02-20  Niels Möller  <nisse@cuckoo.localdomain>

	* src/io_commands.c (do_listen_connection): Raise EXC_IO_LISTEN. 

	* src/tcpforward.c (make_tcpip_forward_request_exc): New function. 
	(do_tcpip_forward_request): Use a better exception handler.

	* src/read_data.c (make_read_data): Deleted assert checking
	send_max_packet.

	* src/zlib.c (do_free_zstream): Changed message from verbose() to
	debug():

	* src/testsuite/Makefile.am (TS_MORE_SH): Added tcpip-remote-test. 

	* src/testsuite/functions.sh: Pass --enable-core to lshd.
	Use set -e and set +e.

2000-02-17  Niels Möller  <nisse@cuckoo.localdomain>

	* README: Updated disclaimer to be a little less pessimistic.  

	* doc/TODO, doc/TASKLIST: Updated.

	* doc/lsh.texinfo (Top): Added GNU reference.

	* Makefile.am.in (EXTRA_DIST): Added ANNOUNCE file.

	* configure.in: Bumped version to 0.9.

	* src/zlib.c (do_free_zstream): Only output message about problems
	when freeing the z stream when in debug mode.

2000-02-17  Niels Möller  <nisse@lysator.liu.se>

	* src/zlib.c (do_zlib): Z_BUF_ERROR is normal.

2000-02-15  Niels Möller  <nisse@cuckoo.localdomain>

	* src/unpad.c (do_unpad): Use SSH_MAX_PACKET_FUZZ, as inflating
	happens after unpadding.

	* src/connection.c (handle_connection): Check packet length.

	* configure.in: Bumped version to 0.2.9.

	* src/channel.c (make_channel_read_data): Take packet overhead
	into consideration.
	(make_channel_read_stderr): D:o.

	* src/read_data.c (do_read_data_query): Subtract some overhead
	from the max packet size.
	(make_read_data): Added overhead argument.

2000-02-09  Niels Möller  <nisse@cuckoo.localdomain>

	* acinclude.m4: New file.

	* src/io.c (do_listen_callback): Use socklen_t.
	(do_connect_callback): Use socklen_t.

	* doc/lsh.texinfo: Wrote secions on invoking lsh and lshd. 

2000-02-07  Niels Möller  <nisse@cuckoo.localdomain>

	* src/tcpforward_commands.c (forward_local_port): Use
	connection_remember. 

	* src/io.c (io_iter): Use a double loop around the close logic, to
	handle close-callbacks that close other files.
	Changed shorter debug() messages to use trace() instead.

	* src/connection_commands.c (connection_remember): New command. 

2000-02-06  Niels Möller  <nisse@cuckoo.localdomain>

	* configure.in: Bumped version to 0.2.8.

	* src/tcpforward.c: Adapted to new CHANNEL_REQUEST conventions.

	* src/server_session.c: Adapted to new CHANNEL_REQUEST
	conventions.  

	* src/proxy_session.c: Updated to Bazsi's latest version.

	* src/proxy.c: Updated to Bazsi's latest version.

	* src/lsh_proxy.c: Updated to Bazsi's latest version.

	* src/debug.c (packet_debug): Changed prefix atribute to type
	string.  

	* src/connection_commands.c (make_handshake_info): Added
	debug_comment argument.

	* src/connection.c (make_ssh_connection): New argument
	debug_comment. 

	* src/client_pty.c (do_pty_continuation): Removed old code for the
	(impossible) case x == NULL.

	* src/client.c: Adapted to new CHANNEL_REQUEST conventions. 

	* src/channel.h (ssh_channel): Added active_requests queue
	(Bazsi). 
	(global_request_callback): Deleted class (Bazsi).
	(global_request): Added type, continuation and exception_hnalder
	arguments do the GLOBAL_REQUEST method (Bazsi).
	(channel_request): Likewise.

	* src/channel.c (make_request_status): Renamed from
	make_global_request_status (Bazsi).
	(global_request_continuation): New class (Bazsi).
	(send_global_request_responses): New function (Bazsi).
	(do_global_request_response): Use send_global_request_responses(). 
	(global_request_exception_handler): New class (Bazsi).
	(make_global_request_exception_handler): New function (Bazsi).
	(do_global_request): Pass a continuation and an exception handler
	to the GLOBAL_REQUEST-method.
	(send_channel_request_responses): New function (Bazsi).
	(channel_request_continuation): New class (Bazsi).
	(channel_request_continuation): New class (Bazsi).
	(do_channel_request): Pass a continuation and an exception to the
	CHANNEL_REQUEST-method. 
	(init_channel): Initialize active_requests.

	* src/Makefile.am.in (liblsh_a_SOURCES): AAdded proxy_channel.c
	and proxy_tcpforward.c.

	* src/tcpforward_commands.c (new_tcpip_channel): Use
	format_channel_open(). 

	* src/proxy_session.c (do_proxy_open_channel): Use
	format_channel_open(). 

	* src/lsh-authorize: Tried to remove bash-isms. 

	* src/client.c (new_session): Use format_channel_open.

	* src/channel_commands.h (channel_open_command): Added
	local_channel_number argument to NEW_CHANNEL. 

	* src/channel_commands.c (do_channel_open_command): Call
	alloc_channel() and register_channel(), rather than delegating it
	to the NEW_CHANNEL method. Set the channel's exception handler
	properly. 

	* src/channel.c (use_channel): New function to take a channel in
	use. 
	(register_channel): New argument take_into_use.
	(lookup_channel_reserved): New function that returns channels that
	are marked as reserved, but not in use.
	(do_channel_open_continue): Call register_channel with
	take_in_use=1. 
	(do_channel_open_confirm): Use lookup_channel_reserved(). Call
	use_channel(). 
	(do_channel_open_failure): Use lookup_channel_reserved().
	(format_channel_open): Renamed from prepare_channel_open. Don't
	call alloc_channel() or register_channel().

	* src/channel.h (CHANNEL_FREE, CHANNEL_RESERVED, CHANNEL_IN_USE):
	New three-level classification for the in_use table.

	* src/channel.c (exc_finish_channel_handler): Use pointer to
	connection rather than to its channel table. 

2000-02-05  Niels Möller  <nisse@cuckoo.localdomain>

	* src/client.c (do_exit_status, do_exit_signal): Use the
	connection's exception handler for protocol errors.

	* src/channel.c (do_exc_finish_channel_handler): Raise
	EXC_FINISH_READ using the connection's exception handler.
	(make_exc_finish_channel_handler): Take a connection, rather than
	a channel_table, as argument.

	* src/io.c, src/io.h: Reorganized, and deleted all subclasses of
	lsh_fd.  
	(io_connect): Take a continuation as argument.
	(io_listen): Take an io_callback (typically of type
	io_listen_callback) as argument.
	(make_listen_callback): New function.

	* src/io_commands.c: Replaced io_fd with lsh_fd.

	* src/io_commands.h: Moved listen_value to io.h

	* src/tcpforward_commands.c (forward_local_port,
	tcpip_forward_hook): Catch EXC_CHANNEL_OPEN. 

	* src/proxy.c, src/server_session.c: Replaced io_fd with lsh_fd. 

	* src/read_data.c (make_read_data): Changed return type to
	io_callback. 

	* src/lshd.c: Replaced io_fd with lsh_fd.
	(main): Use make_report_exception_info().

	* src/lsh_types.h (STRSIGNAL): Use _sys_siglist on SGI.

	* src/lsh.h: Added forward declaration of listen_value.

	* src/exception.c (make_report_exception_info): New function. 

	* src/connection_commands.c: Replaced io_fd with lsh_fd.

	* src/command.h (STATIC_CATCH_REPORT): New macro.

	* src/command.c: New command catch_report.

	* src/client.c: Replaced io_fd with lsh_fd.

	* src/channel.c (do_channel_open_failure): Improved exception
	message. 
	(make_channel_read_data, make_channel_read_stderr): Changed return
	type to io_callback. 

2000-02-03  Niels Möller  <nisse@lysator.liu.se>

	* src/client.c (make_accept_service_handler): Use UINT32 for the
	service name.

2000-02-02  Niels Möller  <nisse@lysator.liu.se>

	* configure.in: Added check for inline.
	Bumped version to 0.2.7.

2000-02-02  Niels Möller  <nisse@lysator.liu.se>

	* src/testsuite/functions.sh, src/testsuite/lsh-1-test,
	src/testsuite/lsh-2-test, src/testsuite/lsh-3-test,
	src/testsuite/tcpip-local-test: Fixed bash-isms. 

	* src/argp/argp-fmtstream.c: Define the functions that are defined
	as extern inline in argp_fmtstream.h. Needed for compilers that
	don't have inline.

	* src/argp/argp-help.c (hol_entry_help): Don't use non-constant
	initializers (which is a GNUC extension). 

	* src/argp/argp-parse.c: Declare alloca properly.

	* src/tty.c, src/tty.h: Signedness fixes.

	* src/parse.c, src/parse.h: Signedness fixes.

	* src/keyexchange.c (kex_make_key): Signedness fix.

	* src/io_commands.c (do_connect_continue): Added a FIXME. 

	* src/client.c: Signedness fixes.

	* src/Makefile.am.in (liblsh_a_SOURCES): Removed password.c.

	* configure.in: Added check for inline.
	Bumped version to 0.2.7.

2000-02-01  Niels Möller  <nisse@cuckoo.localdomain>

	* configure.in: Fixed messages for --without-* flags.

2000-01-27  Niels Möller  <nisse@cuckoo.localdomain>

	* doc/lsh.texinfo: Added some more sections.

	* src/channel.c (channel_transmit_data,
	channel_transmit_extended): Shrink send_window_size
	(noted by Markus).

2000-01-26  Niels Möller  <nisse@cuckoo.localdomain>

	* src/testsuite/Makefile.am (TS_MORE_SH): Added tcpip-local-test.
	(EXTRA_DIST): Added new files.
	(check-some): Don't use $^, to avoid the VPATH feature.

	* src/tcpforward_commands.c (DIRECT_TCPIP_HANDLER): New define. 
	(INSTALL_DIRECT_TCPIP): New define.

	* src/tcpforward.c (lookup_forward): Use CAST_SUBTYPE.
	(do_tcpip_channel_die): Call close_fd() rather than kill_fd().
	(tcpip_channel_start_io): Don't call channel_start_receive().
	(make_exc_tcpip_connect_handler): New exception handler, which
	raises EXC_CHANNEL_OPEN on connect and dns errors.
	(do_open_forwarded_tcpip_continuation): Require that channel !=
	NULL.
	(make_open_forwarded_tcpip_continuation): Removed
	exception_handler argument.
	(do_channel_open_direct_tcpip): Use a better exception handler.
	(do_channel_open_forwarded_tcpip): -"-

	* src/lsh.c (do_lsh_default_handler): Handle EXC_CHANNEL_OPEN.

	* src/channel.c (make_exc_channel_open_handler): Added missing
	context argument.
	(do_window_adjust): Check for CHANNEL_SENT_EOF, so that we don't
	attempt to send data after EOF.

	* configure.in: Bumped version to 0.2.6.

	* src/testsuite/Makefile.am: Don't use automake's builtin
	testsuite-support. 

	* src/io.c (do_consuming_read): Don't die on EPIPE.

2000-01-22  Niels Möller  <nisse@cuckoo.localdomain>

	* src/channel.c (exc_finish_channel_handler): New attribute dead,
	to keep track of channels that have already been deallocated.
	Reported by Markus.

	* src/channel.c: Deleted some old commented-out definitions.

	* src/scm/gaba.scm (type->mark): Handle space-variables with an
	optional third argument just like pointer-variables with three
	arguments. I.e. use the third arg as the name of a field holding
	the current size of an array. Reported by Bazsi. For now, doesn't
	try to free array elements (which is ok as long as the arrays are
	used for objects subject to gc).

	* configure.in: Bumped version to 0.2.5.

2000-01-20  Niels Möller  <nisse@cuckoo.localdomain>

	* configure.in: Prefer guile if both guile and scsh are installed. 

	* src/channel.c (dealloc_channel): Fixed verbose message.

	* configure.in: Bumped version to 0.2.4.

2000-01-18  Niels Möller  <nisse@cuckoo.localdomain>

	* src/zlib.c (RATE_MAX, RATE_MIN): Use rates between 1/16 and 16.
	(estimate_update): Fixed estimate. Also ignore small packets.
	(do_zlib): Fixed stop condition (noted by Markus Friedl).

2000-01-13  Niels Möller  <nisse@cuckoo.localdomain>

	* Makefile.am.in (EXTRA_DIST): Added distribution-key.gpg.

	* configure.in: Bumped version to 0.2.3.

2000-01-12  Niels Möller  <nisse@cuckoo.localdomain>

	* src/tcpforward.c (do_channel_open_direct_tcpip): Added type
	argument (Bazsi).
	(do_channel_open_forwarded_tcpip): D:o.

	* src/server_userauth.c (do_handle_userauth): Call connection_lock().
	(do_userauth_continuation): Call connection_unlock().
	(do_exc_userauth_handler): D:o.
	(make_exc_userauth_handler): Made non-static (Bazsi).
	(do_userauth): Don't call make_once_continuation().

	* src/server_session.c (do_open_session): Added type argument
	(Bazsi). 

	* src/lshd.c: Added options --password, --no-password, --publickey
	and --no-publickey.

	* src/io.c (io_iter): Improved comment on POLLHUP behaviour.

	* src/connection.h (ssh_connection): Added busy attribute.

	* src/connection.c (handle_connection): Disconnect if connections
	is busy.
	(connection_lock): New function.
	(connection_unlock): New function.

	* src/channel.h (CHANNEL_OPEN): Added type argument (Bazsi).

	* src/channel.c: Change verbose messages to display remote channel
	numbers, as well local numbers where they are easily available.

	* src/lsh_proxy.c, src/proxy.c, src/proxy.h, src/proxy_session.c,
	src/proxy_session.h, src/proxy_userauth.c, src/proxy_userauth.h:
	Applied Bazsi's patches.

2000-01-09  Niels Möller  <nisse@cuckoo.localdomain>

	* src/unpad.c (do_unpad): Check payload length.

	* src/connection.c (make_ssh_connection): Use
	SSH_MAX_PACKET_FUZZ. 

	* src/ssh.h (SSH_MAX_PACKET_FUZZ): New constant.

	* src/read_packet.c (do_read_packet): Added comment on the packet
	size limit.

	* src/lsh_types.h: Include alloca.h, where appropriate.

	* src/io.c (io_set_nonblocking): Leave other flags unmodified.
	(io_set_close_on_exec): The same, even though there are currently
	no other flag bits specified.

	* src/zlib.c (make_zlib_instance): Bug fix: Initialize instance
	variables max, rate and f.
	(do_zlib): Fixed call to string_buffer_final.

	* src/keyexchange.c (do_handle_kexinit): Added verbose messages
	listing selected algorithms.

	* src/zlib.c (make_zlib_instance): Initialize deflate/inflate
	pointer properly. (Reported by Keresztg).

2000-01-08  Niels Möller  <nisse@cuckoo.localdomain>

	* src/io.c (io_set_nonblocking): Use fcntl(F_GETFL) to leave flags
	other than the O_NONBLOCK flag unmodified.

2000-01-06  Niels Möller  <nisse@cuckoo.localdomain>

	* src/io.c (MY_POLLIN): poll kludge, use both POLLIN and
	POLLRDNORM. 

	* configure.in (LIBOBJS): Use correct path to the argp object
	files.

	* README: Document dependency on GU make. Recommend running
	configure with bash. Say that guile in the build environment is
	suppported.

	* src/channel.c (alloc_channel): Added verbose messages.
	(dealloc_channel): d:o.
	(register_channel): d:o.
	(do_channel_eof): d:o.
	(do_channel_close): d:o.
	(channel_close): d:o.
	(channel_eof): d:o.

	* doc/lsh.texinfo: Updated nodes and menus.

	* doc/Makefile.am.in (info_TEXINFOS): Added lsh-texinfo.

	* Makefile.am.in (EXTRA_DIST): Added ChangeLog.1.

	* configure.in: Bumped version to 0.2.1.

1999-12-31  Niels Möller  <nisse@cuckoo.localdomain>

	* src/daemon.c: Include sys/time.h.

	* src/command.c (progn_command): Let (progn ()), i.e. an empty
	list of commands, result in the identity command.

	* configure.in: Deleted old versions of the utmp tests.
	Added test for socklen_t.
	List the individual argp object files in LIBOBJS.

	* src/lsh.c (do_lsh_default_handler): Fail on EXC_CHANNEL_REQUEST
	exceptions. 
	(main_argp_parser): Ignore EXC_CHANNEL_REQUEST exceptions when
	requesting a pty. 

	* src/command.c (do_catch_handler): Let !handler mean that the
	exception is to be ignored.

	* src/lshd.c: Added options --pty-support and --no-pty-support. 

	* configure.in: Bumped version to 000.2, for the obvious reason. 

1999-12-29  Niels Möller  <nisse@cuckoo.localdomain>

	* src/spki.h: #include <time.h>, for definition of time_t.

Sat Dec 25 18:18:45 1999  Niels Möller  <nisse@lysator.liu.se>

	* configure.in: Quote fallback definition of M4.

	* acconfig.h: Use more standard #undef's for VERSION and PACKAGE. 

	* src/process_atoms (atom2define): Bug fix.

	* src/argp/argp-help.c (strndup): Bug fix.

	* src/process_atoms (atom2define): Workaround for seds that can't
	handle input without a final newline.

1999-12-25  Niels Möller  <nisse@cuckoo.localdomain>

	* src/argp/argp.h: Workaround for __restrict.

	* src/testsuite/keygen-test: Use $srcdir to find input file.

	* src/testsuite/keygen-test: New test script.

	* src/spki_commands.c (spki_read_hostkeys, spki_read_userkeys):
	Use sexp2keypair. Also deleted some old dead code.
	
	* src/spki.c (do_spki_sexp2signer): New function.
	(spki_sexp2signer_command): New command. 
	(spki_parse_private_key): Renamed to spki_sexp2keypair. 

	* src/lsh_writekey.c (make_writekey): Use sexp2signer, and pass
	algorithms alist as argument.

	* configure.in: Bumped version to 0.1.20.

	* src/werror.h: Include stdarg.h (moved from werror.c).

	* src/spki.c (do_spki_lookup): Fixed call to spki_make_verifier(). 

